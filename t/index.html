i<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyAdmcHXRQve3WoQQiY8_xuJZdciCCX9nwg"></script>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
  </head>
  <body>
    <div id="map-canvas"></div>
    <script type="text/javascript">

google.maps.event.addDomListener(window, 'load', function() {
  var view = new TripView();
  var trip = new Trip(view);

  var tripId = window.location.hash;
  if(!tripId || tripId.substring(0,1) != "#") {
    console.log("trip not set")
    return;
  }

  tripId = tripId.substring(1)
  var tripSocket = new WebSocket("ws://192.241.229.86:9000/position/subscribe/" + tripId);
  tripSocket.onmessage = trip.listenForPositions.bind(trip); 
});

var Trip = function Trip(view) {
  this.view = view;
  this.positions = [];
}

Trip.prototype.listenForPositions = function listenForPositions(event) {
  var pos = JSON.parse(event.data);
  console.info(event.data)
  this.positions.push(new google.maps.LatLng(pos.lat, pos.lon)); 
  this.view.draw(this.positions);
}

var TripView = function TripView() {
  var mapOptions = {
    center: { lat: -34.397, lng: 150.644},
    zoom: 12,
    styles: [{"featureType":"landscape.man_made","elementType":"geometry","stylers":[{"color":"#f7f1df"}]},{"featureType":"landscape.natural","elementType":"geometry","stylers":[{"color":"#d0e3b4"}]},{"featureType":"landscape.natural.terrain","elementType":"geometry","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"poi.business","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.medical","elementType":"geometry","stylers":[{"color":"#fbd3da"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#bde6ab"}]},{"featureType":"road","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffe15f"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#efd151"}]},{"featureType":"road.arterial","elementType":"geometry.fill","stylers":[{"color":"#ffffff"}]},{"featureType":"road.local","elementType":"geometry.fill","stylers":[{"color":"black"}]},{"featureType":"transit.station.airport","elementType":"geometry.fill","stylers":[{"color":"#cfb2db"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#a2daf2"}]}]
  };
  this.map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  this.tripPath = new google.maps.Polyline({
    path: [],
    strokeColor: "#FF0000",
    strokeOpacity: 0.5,
    strokeWeight: 2,
    map: this.map,
  });

  this.listenForUserInteraction();
};

TripView.prototype.listenForUserInteraction = function listenForUserInteraction() {
  var self = this;
  google.maps.event.addListener(this.map, 'mousedown', function() {
    self.lastUserInteraction = new Date();
  });
}

TripView.prototype.draw = function draw(positions) {
  positions = positions.sort(function(a, b) {
    return a.order > b.order;
  });
  window.cancelAnimationFrame(this.lastAnimationFrame);
  this.animate(positions);
}

TripView.prototype.animate = function animate(positions, animationStart) {
  var progress = 0;
  var posCount = positions.length;

  if(!animationStart) {
    animationStart = new Date();

    if(!this.lastUserInteraction || (new Date() - this.lastUserInteraction) / 1000 > 10)
      this.map.panTo(positions[posCount-1]);
  } else {
    if(posCount <= 1) {
      this.tripPath.setPath(positions);
      return;
    }
    
    var progress = (new Date() - animationStart) / 1000;

    var animatedPositions = positions.slice(0, posCount - 1);
    animatedPositions.push(google.maps.geometry.spherical.interpolate(positions[posCount - 2], positions[posCount-1], progress));

    this.tripPath.setPath(animatedPositions);
  }

  if(progress < 1)
    this.lastAnimation = window.requestAnimationFrame(this.animate.bind(this, positions, animationStart));
}
    </script>
  </body>
</html>
